<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

  <on-start>
    <set name="flowScope.nextUrl" value="webflowUrlHelper.getLogoutUrl(flowRequestContext)"/>
  </on-start>

  <decision-state id="isLoggedIn">
    <if test="liveContextUserService.isLoggedIn(flowRequestContext.externalContext.nativeRequest)" then="logoutAction" else="success"/>
  </decision-state>


  <view-state id="logout" view="logout">
    <transition on="submit" to="logoutAction"/>
  </view-state>

  <action-state id="logoutAction">
    <evaluate expression="liveContextUserService.logoutUser(flowRequestContext.externalContext.nativeRequest, flowRequestContext.externalContext.nativeResponse, flowRequestContext)"/>
    <transition on="yes" to="success"/>
    <transition on="no" to="success"/>
  </action-state>

  <end-state id="success" view="externalRedirect:contextRelative:/j_spring_security_logout?spring-security-redirect=#{nextUrl}" />

</flow>