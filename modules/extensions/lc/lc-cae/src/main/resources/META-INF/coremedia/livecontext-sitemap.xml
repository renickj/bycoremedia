<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:customize="http://www.coremedia.com/2007/coremedia-spring-beans-customization"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.coremedia.com/2007/coremedia-spring-beans-customization http://www.coremedia.com/2007/coremedia-spring-beans-customization.xsd">

  <import resource="classpath:/com/coremedia/cae/link-services.xml"/>
  <import resource="classpath:/com/coremedia/cap/common/uapi-services.xml"/>
  <import resource="classpath:/com/coremedia/cap/multisite/multisite-services.xml"/>
  <import resource="classpath:/framework/spring/blueprint-sitemap.xml"/>
  <import resource="classpath:/com/coremedia/blueprint/base/navigation/context/bpbase-default-contextstrategy.xml"/>
  <import resource="classpath:/com/coremedia/blueprint/base/multisite/bpbase-multisite-services.xml"/>
  <import resource="classpath:/META-INF/coremedia/component-lc-ecommerce-ibm.xml"/>
  <import resource="livecontext-navigation.xml"/>
  <import resource="livecontext-site-services.xml"/>


  <!--
    sitemap.org sitemap
  -->

  <bean id="livecontextSitemapDoctypePredicate" class="com.coremedia.blueprint.cae.sitemap.SitemapDoctypePredicate">
    <property name="capConnection" ref="connection"/>
    <property name="includes">
      <list>
        <value>CMTeasable</value>
      </list>
    </property>
    <property name="excludes">
      <list>
        <!--
          Product teaser links are deep links of the shop domain and thus not
          allowed in the sitemap of the CMS domain.
        -->
        <value>CMProductTeaser</value>
        <value>CMMedia</value>
        <value>CMExternalLink</value>
        <value>CMAction</value>
        <value>CMPlaceholder</value>
        <value>CMDynamicList</value>
        <value>CMTeaser</value>
      </list>
    </property>
  </bean>

  <bean id="livecontextExcludeFromSearchPredicate" class="com.coremedia.blueprint.cae.sitemap.ExcludeFromSearchSitemapPredicate">
    <property name="doctypeName" value="CMTeasable"/>
    <property name="notSearchablePropertyName" value="notSearchable"/>
  </bean>

  <bean id="livecontextSitemapValidityPredicate" class="com.coremedia.blueprint.cae.common.predicates.ValidContentPredicate">
    <property name="contentBeanFactory" ref="contentBeanFactory"/>
  </bean>

  <bean id="livecontextSitemapContentUrlGenerator" class="com.coremedia.blueprint.cae.sitemap.ContentUrlGenerator" parent="abstractContentUrlGenerator">
    <property name="exclusionPaths">
      <list>
        <value>Options</value>
      </list>
    </property>
    <property name="predicates">
      <list>
        <ref bean="livecontextSitemapValidityPredicate"/>
        <ref bean="livecontextSitemapDoctypePredicate"/>
        <ref bean="livecontextExcludeFromSearchPredicate"/>
      </list>
    </property>
  </bean>

  <bean id="livecontextSitemapCatalogUrlGenerator" class="com.coremedia.livecontext.sitemap.CatalogSitemapUrlGenerator">
    <property name="settingsService" ref="settingsService" />
    <property name="liveContextNavigationFactory" ref="liveContextNavigationFactory"/>
    <property name="linkFormatter" ref="linkFormatter"/>
  </bean>

  <bean id="livecontextSitemapConfiguration" class="com.coremedia.blueprint.cae.sitemap.SitemapSetup">
    <property name="protocol" value="http"/>
    <property name="sitemapRendererFactory" ref="sitemapIndexRendererFactory"/>
    <property name="urlGenerators">
      <list>
        <ref bean="livecontextSitemapContentUrlGenerator"/>
        <ref bean="livecontextSitemapCatalogUrlGenerator"/>
      </list>
    </property>
  </bean>

  <customize:append id="appendLivecontextSitemapConfiguration" bean="sitemapConfigurations">
    <map>
      <entry key="livecontext" value-ref="livecontextSitemapConfiguration"/>
    </map>
  </customize:append>


  <!--
    Sitemap for CMS content in WCS search index, PCS-Mode
  -->
  <bean id="wcsPcsSitemapDoctypePredicate" class="com.coremedia.blueprint.cae.sitemap.SitemapDoctypePredicate">
    <property name="capConnection" ref="connection"/>
    <property name="includes">
      <list>
        <value>CMLinkable</value>
      </list>
    </property>
    <property name="excludes">
      <list>
        <value>CMTeaser</value>
        <value>CMCollection</value>
        <value>CMMedia</value>
        <value>CMExternalLink</value>
        <value>CMAction</value>
        <value>CMPlaceholder</value>
        <value>CMProductTeaser</value>
      </list>
    </property>
  </bean>

  <bean id="wcsPcsContentUrlGenerator" class="com.coremedia.livecontext.sitemap.WcsPcsContentUrlGenerator" parent="abstractContentUrlGenerator">
    <property name="predicates">
      <list>
        <ref bean="livecontextSitemapValidityPredicate"/>
        <ref bean="wcsPcsSitemapDoctypePredicate"/>
        <ref bean="livecontextExcludeFromSearchPredicate"/>
      </list>
    </property>
  </bean>

  <bean id="sitemapWcsPcsRendererFactory" class="com.coremedia.livecontext.sitemap.SitemapWcsPcsRendererFactory"/>

  <bean id="sitemapWcsPcsConfig" class="com.coremedia.blueprint.cae.sitemap.SitemapSetup">
    <property name="sitemapRendererFactory" ref="sitemapWcsPcsRendererFactory"/>
    <property name="urlGenerators">
      <list>
        <ref bean="wcsPcsContentUrlGenerator"/>
      </list>
    </property>
  </bean>

  <bean id="sitemapWcsPcsController" class="com.coremedia.livecontext.sitemap.WcsPcsSitemapGenerationHandler">
    <property name="siteResolver" ref="siteResolver"/>
    <property name="sitemapSetupFactory" ref="sitemapWcsPcsSetupFactory"/>
  </bean>

  <bean id="sitemapWcsPcsSetupFactory" class="com.coremedia.blueprint.cae.sitemap.SpringBasedSitemapSetupFactory">
    <property name="sitemapSetup" ref="sitemapWcsPcsConfig"/>
  </bean>


  <!--
    Sitemap for CMS content in WCS search index, AAS-Mode
  -->
  <bean id="wcsAasCrawlSitemapPredicate" class="com.coremedia.livecontext.sitemap.WcsAasCrawlSitemapPredicate">
  </bean>

  <bean id="wcsAasContentUrlGenerator" class="com.coremedia.livecontext.sitemap.WcsAasContentUrlGenerator" parent="abstractContentUrlGenerator">
    <property name="predicates">
      <list>
        <ref bean="livecontextSitemapValidityPredicate"/>
        <ref bean="wcsAasCrawlSitemapPredicate"/>
      </list>
    </property>
    <property name="sitesService" ref="sitesService"/>
    <property name="wcsStorefrontUrl" value="${livecontext.ibm.wcs.storefront.url}"/>
    <property name="contextStrategy" ref="contentContextStrategy"/>
    <property name="urlKeyword" value="${livecontext.ibm.wcs.url-keyword}"/>
    <property name="linkFormatter" ref="linkFormatter"/>
  </bean>

  <bean id="sitemapWcsAasRendererFactory" class="com.coremedia.livecontext.sitemap.SitemapWcsAasRendererFactory"/>

  <bean id="sitemapWcsAasConfig" class="com.coremedia.blueprint.cae.sitemap.SitemapSetup">
    <property name="sitemapRendererFactory" ref="sitemapWcsAasRendererFactory"/>
    <property name="urlGenerators">
      <list>
        <ref bean="wcsAasContentUrlGenerator"/>
      </list>
    </property>
  </bean>

  <bean id="sitemapWcsAasController" class="com.coremedia.livecontext.sitemap.WcsAasSitemapGenerationHandler">
    <property name="siteResolver" ref="siteResolver"/>
    <property name="sitemapSetupFactory" ref="sitemapWcsAasSetupFactory"/>
  </bean>

  <bean id="sitemapWcsAasSetupFactory" class="com.coremedia.blueprint.cae.sitemap.SpringBasedSitemapSetupFactory">
    <property name="sitemapSetup" ref="sitemapWcsAasConfig"/>
  </bean>
</beans>
