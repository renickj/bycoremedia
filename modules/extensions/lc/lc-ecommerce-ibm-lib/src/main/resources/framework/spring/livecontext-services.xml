<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:customize="http://www.coremedia.com/2007/coremedia-spring-beans-customization"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                            http://www.coremedia.com/2007/coremedia-spring-beans-customization http://www.coremedia.com/2007/coremedia-spring-beans-customization.xsd">

  <import resource="classpath:/framework/spring/livecontext-cache.xml"/>
  <import resource="classpath:/framework/spring/livecontext-ibm-cache.xml"/>
  <import resource="classpath:/framework/spring/livecontext-storeconfig.xml"/>
  <import resource="classpath:/com/coremedia/blueprint/base/livecontext/studio/cache.xml"/>

  <context:annotation-config/>

  <bean id="restConnector" class="com.coremedia.livecontext.ecommerce.ibm.common.WcRestConnector">
    <property name="serviceEndpoint" value="${livecontext.ibm.wcs.rest.url}"/>
    <property name="searchServiceEndpoint" value="${livecontext.ibm.wcs.rest.search.url}"/>
    <property name="serviceSslEndpoint" value="${livecontext.ibm.wcs.rest.secureUrl}"/>
    <property name="searchServiceSslEndpoint" value="${livecontext.ibm.wcs.rest.search.secureUrl}"/>
    <property name="trustAllSslCertificates" value="true"/>
    <property name="loginService" ref="userLoginService"/>
    <property name="connectionPoolSize" value="${livecontext.rest.connector.connectionPoolSize}"/>
    <property name="connectionTimeout" value="${livecontext.rest.connector.connectionTimeout}"/>
    <property name="socketTimeout" value="${livecontext.rest.connector.socketTimeout}"/>
  </bean>

  <bean id="storefrontConnector" class="com.coremedia.livecontext.ecommerce.ibm.common.WcStorefrontConnector">
    <property name="connectorHelper" ref="connectorHelper"/>
    <property name="connectionPoolSize" value="${livecontext.storefront.connector.connectionPoolSize}"/>
    <property name="connectionTimeout" value="${livecontext.storefront.connector.connectionTimeout}"/>
    <property name="socketTimeout" value="${livecontext.storefront.connector.socketTimeout}"/>
  </bean>

  <bean id="connectorHelper" class="com.coremedia.livecontext.ecommerce.ibm.common.ConnectorHelper">
  </bean>

  <bean id="commerceBeanFactory" class="com.coremedia.blueprint.base.livecontext.ecommerce.common.SpringCommerceBeanFactory"/>

  <bean id="catalogWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.catalog.WcCatalogWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="contractWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.contract.WcContractWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="availabilityWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.inventory.WcAvailabilityWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="marketingSpotWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.p13n.WcMarketingSpotWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="cartWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.order.WcCartWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="loginWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.login.WcLoginWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="personWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.user.WcPersonWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="searchWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.search.WcSearchWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="segmentWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.p13n.WcSegmentWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="workspaceWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.workspace.WcWorkspaceWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="catalogService" class="com.coremedia.livecontext.ecommerce.ibm.catalog.CatalogServiceImpl">
    <property name="catalogWrapperService" ref="catalogWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
    <property name="wcsUrl" value="http:${livecontext.apache.wcs.url}"/>
    <property name="wcsStoreUrl" value="${livecontext.ibm.wcs.store.url}"/>
    <property name="wcsAssetsUrl" value="${livecontext.ibm.wcs.assets.url}"/>
  </bean>

  <bean id="availabilityService" class="com.coremedia.livecontext.ecommerce.ibm.inventory.AvailabilityServiceImpl">
    <property name="availabilityWrapperService" ref="availabilityWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="contractService" class="com.coremedia.livecontext.ecommerce.ibm.contract.ContractServiceImpl">
    <property name="contractWrapperService" ref="contractWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
    <property name="contractPreviewServiceUserName" value="${livecontext.ibm.contract.preview.credentials.username}"/>
  </bean>

  <bean id="marketingSpotService" class="com.coremedia.livecontext.ecommerce.ibm.p13n.MarketingSpotServiceImpl">
    <property name="marketingSpotWrapperService" ref="marketingSpotWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="cartService" class="com.coremedia.livecontext.ecommerce.ibm.order.CartServiceImpl">
    <property name="cartWrapperService" ref="cartWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
  </bean>

  <bean id="userLoginService" class="com.coremedia.livecontext.ecommerce.ibm.login.LoginServiceImpl">
    <property name="servicePassword" value="${livecontext.service.credentials.password}"/>
    <property name="serviceUser" value="${livecontext.service.credentials.username}"/>
    <property name="loginWrapperService" ref="loginWrapperService"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="searchService" class="com.coremedia.livecontext.ecommerce.ibm.search.SearchServiceImpl">
    <property name="searchWrapperService" ref="searchWrapperService"/>
  </bean>

  <bean id="segmentService" class="com.coremedia.livecontext.ecommerce.ibm.p13n.SegmentServiceImpl">
    <property name="segmentWrapperService" ref="segmentWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="workspaceService" class="com.coremedia.livecontext.ecommerce.ibm.workspace.WorkspaceServiceImpl">
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
    <property name="workspaceWrapperService" ref="workspaceWrapperService"/>
  </bean>

  <bean id="storeFrontService" class="com.coremedia.livecontext.ecommerce.ibm.common.StoreFrontService"
        abstract="true">
    <property name="storefrontConnector" ref="storefrontConnector"/>
    <property name="storeContextProvider" ref="storeContextProvider"/>
    <property name="urlProvider" ref="pageHandlerUrlProvider"/>
  </bean>

  <bean id="commerceUserService" class="com.coremedia.livecontext.ecommerce.ibm.user.UserServiceImpl">
    <property name="personWrapperService" ref="personWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="commerceUserSessionService" class="com.coremedia.livecontext.ecommerce.ibm.user.UserSessionServiceImpl"
        parent="storeFrontService">
    <property name="commerceCache" ref="commerceCache"/>
    <property name="urlProvider" ref="pageHandlerUrlProvider"/>
    <property name="wcsStorefrontUrl" value="${livecontext.ibm.wcs.default.url}"/>
    <property name="loginWrapperService" ref="loginWrapperService"/>
    <property name="userService" ref="commerceUserService" />
  </bean>

  <bean id="userContextProvider" class="com.coremedia.livecontext.ecommerce.ibm.user.UserContextProviderImpl">
    <property name="userSessionService" ref="commerceUserSessionService" />
  </bean>

  <bean id="commerceIdProvider" class="com.coremedia.livecontext.ecommerce.ibm.common.CommerceIdProviderImpl"/>

  <bean id="pageHandlerUrlProvider" class="com.coremedia.livecontext.ecommerce.ibm.common.CommerceUrlPropertyProvider">
    <property name="defaultStoreFrontUrl" value="${livecontext.ibm.wcs.storefront.url}"/>
    <property name="previewStoreFrontUrl" value="${livecontext.ibm.wcs.storefront.preview.url}"/>
    <property name="urlPattern" value="{language}/{storeName}/{seoSegment}"/>
    <property name="nonSeoUrlPattern" value="{pageType}"/>
    <property name="shoppingFlowUrlForContractPreview" value="${livecontext.ibm.contract.preview.url}"/>
  </bean>

  <bean id="storeContextProvider" class="com.coremedia.livecontext.ecommerce.ibm.common.StoreContextProviderImpl">
    <property name="sitesService" ref="sitesService"/>
    <property name="settingsService" ref="settingsService"/>
    <property name="wcsVersion" value="${livecontext.ibm.wcs.version}"/>
    <property name="storeConfigurations" ref="ibmStoreConfigurations"/>
    <property name="storeInfoService" ref="storeInfoService"/>
    <property name="cache" ref="cache"/>
  </bean>

  <!-- Cache beans -->

  <bean id="cacheWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.event.WcCacheWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <!-- activate this for active commerce cache invalidation -->
  <bean id="commerceCacheInvalidationListener"
        class="com.coremedia.livecontext.ecommerce.ibm.event.CommerceCacheInvalidationListener">
    <property name="wcCacheWrapperService" ref="cacheWrapperService"/>
    <property name="enabled" value="${livecontext.ibm.wcs.cache.invalidation.enabled}"/>
    <property name="cacheInvalidationPropagators">
      <list>
        <ref bean="commerceCacheInvalidationPropagatorImpl"/>
      </list>
    </property>
  </bean>

  <bean id="assetUrlProvider" class="com.coremedia.livecontext.ecommerce.ibm.asset.AssetUrlProviderImpl">
    <property name="commercePreviewUrl" value="${livecontext.apache.preview.wcs.url}"/>
    <property name="commerceProductionUrl" value="${livecontext.apache.wcs.url}"/>
    <property name="cmsHost" value="${blueprint.host.helios}"/>
    <property name="catalogPathPrefix" value="${livecontext.ibm.wcs.store.catalog.asset.path}"/>
  </bean>

  <bean id="previewTokenProvider" class="com.coremedia.livecontext.ecommerce.ibm.login.PreviewTokenProvider">
    <property name="loginService" ref="userLoginService"/>
  </bean>

  <bean id="storeInfoService" class="com.coremedia.livecontext.ecommerce.ibm.storeinfo.StoreInfoServiceImpl">
    <property name="wrapperService" ref="storeInfoWrapperService"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="storeInfoWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.storeinfo.WcStoreInfoWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <customize:append id="commerceCacheInvalidationListenerCustomizer" bean="commerceCacheInvalidationListener"
                    property="cacheInvalidationPropagators">
    <list>
      <ref bean="commerceInvalidationsSource"/>
    </list>
  </customize:append>

</beans>