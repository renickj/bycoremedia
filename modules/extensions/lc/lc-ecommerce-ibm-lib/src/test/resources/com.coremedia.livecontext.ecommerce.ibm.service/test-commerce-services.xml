<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

  <context:annotation-config/>

  <import resource="classpath:com/coremedia/cap/common/uapi-services.xml"/>
  <import resource="classpath:/com/coremedia/blueprint/base/settings/impl/bpbase-settings-services.xml"/>
  <import resource="classpath:/com/coremedia/blueprint/base/multisite/bpbase-multisite-services.xml"/>
  <import resource="classpath:/com/coremedia/cae/contentbean-services.xml"/>
  <import resource="classpath:/framework/spring/search/solr-search.xml"/>
  <import resource="classpath:/framework/spring/lc-ecommerce-connection.xml"/>

  <context:property-placeholder
          ignore-unresolvable="true"
          location="/com.coremedia.livecontext.ecommerce.ibm.service/test-commerce-services.properties"
          system-properties-mode="OVERRIDE"/>

  <bean id="sitesService" class="com.coremedia.cap.multisite.impl.SitesServiceImpl">
    <property name="capConnection" ref="connection"/>
    <property name="siteModel" ref="siteModel"/>
  </bean>

  <bean id="siteModel" class="com.coremedia.blueprint.base.multisite.BlueprintSiteModel">
    <property name="siteIndicatorDocumentType" value="CMSite"/>
    <property name="siteIndicatorDepth" value="1"/>
    <property name="idProperty" value="id"/>
    <property name="localeProperty" value="locale"/>
    <property name="masterProperty" value="master"/>
    <property name="masterVersionProperty" value="masterVersion"/>
    <property name="rootProperty" value="root"/>
    <property name="uriSegmentProperty" value="segment"/>
    <property name="siteIndicatorNamePattern" value="{0} [Site]"/>
    <property name="siteRootDocumentNamePattern" value="{0}"/>
    <property name="siteManagerGroupProperty" value="siteManagerGroup"/>
    <property name="translationManagerRole" value="translation-manager-role"/>
    <property name="uriSegmentPattern" value="{0}-{4}"/>
    <property name="siteManagerGroupPattern" value="manager-{4}"/>
    <property name="rootFolderPathPattern" value="/Sites/{0}/{6}/{5}"/>
    <property name="rootFolderPathDefaultCountry" value="NO_COUNTRY"/>
    <property name="nameProperty" value="name"/>
    <property name="translationWorkflowRobotUser" value="translation-workflow-robot"/>
  </bean>

  <bean id="testConfig" class="com.coremedia.livecontext.ecommerce.ibm.common.TestConfig">
    <property name="wcsVersion" value="${livecontext.ibm.wcs.version}"/>
  </bean>

  <bean id="connectorHelper" class="com.coremedia.livecontext.ecommerce.ibm.common.ConnectorHelper">
  </bean>

  <!-- activate this for active commerce cache invalidation -->
  <bean id="commerceCacheInvalidationListener"
        class="com.coremedia.livecontext.ecommerce.ibm.event.CommerceCacheInvalidationListener" scope="singleton">
    <property name="enabled" value="false"/>
    <property name="wcCacheWrapperService" ref="cacheWrapperService"/>
    <property name="cacheInvalidationPropagators">
      <list>
        <ref bean="commerceCacheInvalidationPropagatorImpl"/>
      </list>
    </property>
  </bean>

  <bean id="commerceCacheInvalidationPropagatorImpl"
        class="com.coremedia.livecontext.ecommerce.ibm.event.CommerceCacheInvalidationPropagatorImpl">
    <property name="cache" ref="cache"/>
  </bean>

  <bean id="availabilityWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.inventory.WcAvailabilityWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="marketingSpotWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.p13n.WcMarketingSpotWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>
  
  <bean id="contractWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.contract.WcContractWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="contractService" class="com.coremedia.livecontext.ecommerce.ibm.contract.ContractServiceImpl">
      <property name="contractWrapperService" ref="contractWrapperService"/>
      <property name="commerceCache" ref="commerceCache"/>
      <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
  </bean>


  <bean id="cartWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.order.WcCartWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="personWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.user.WcPersonWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="searchWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.search.WcSearchWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="segmentWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.p13n.WcSegmentWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="commerceBeanFactory" class="com.coremedia.blueprint.base.livecontext.ecommerce.common.SpringCommerceBeanFactory"/>

  <bean id="catalogIdScheme" class="com.coremedia.blueprint.base.livecontext.ecommerce.common.CommerceIdScheme"/>

  <bean id="availabilityService" class="com.coremedia.livecontext.ecommerce.ibm.inventory.AvailabilityServiceImpl">
    <property name="availabilityWrapperService" ref="availabilityWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="marketingSpotService" class="com.coremedia.livecontext.ecommerce.ibm.p13n.MarketingSpotServiceImpl">
    <property name="marketingSpotWrapperService" ref="marketingSpotWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>
  

  <bean id="cartService" class="com.coremedia.livecontext.ecommerce.ibm.order.CartServiceImpl">
    <property name="cartWrapperService" ref="cartWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
  </bean>

  <bean id="searchService" class="com.coremedia.livecontext.ecommerce.ibm.search.SearchServiceImpl">
    <property name="searchWrapperService" ref="searchWrapperService"/>
  </bean>

  <bean id="segmentService" class="com.coremedia.livecontext.ecommerce.ibm.p13n.SegmentServiceImpl">
    <property name="segmentWrapperService" ref="segmentWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="workspaceWrapperService"
        class="com.coremedia.livecontext.ecommerce.ibm.workspace.WcWorkspaceWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="workspaceService" class="com.coremedia.livecontext.ecommerce.ibm.workspace.WorkspaceServiceImpl">
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
    <property name="workspaceWrapperService" ref="workspaceWrapperService"/>
  </bean>

  <bean id="cacheWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.event.WcCacheWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="storefrontConnector" class="com.coremedia.livecontext.ecommerce.ibm.common.WcStorefrontConnector">
    <property name="connectorHelper" ref="connectorHelper"/>
  </bean>

  <bean id="userContextProvider" class="com.coremedia.livecontext.ecommerce.ibm.user.UserContextProviderImpl">
    <property name="userSessionService" ref="commerceUserSessionService"/>
  </bean>

  <bean id="storeFrontService" class="com.coremedia.livecontext.ecommerce.ibm.common.StoreFrontService" abstract="true">
    <property name="storefrontConnector" ref="storefrontConnector"/>
    <property name="storeContextProvider" ref="storeContextProvider"/>
    <property name="urlProvider" ref="pageHandlerUrlProvider"/>
  </bean>

  <bean id="pageHandlerUrlProvider" class="com.coremedia.livecontext.ecommerce.ibm.common.CommerceUrlPropertyProvider"/>

  <bean id="commerceUserService" class="com.coremedia.livecontext.ecommerce.ibm.user.UserServiceImpl">
    <property name="personWrapperService" ref="personWrapperService"/>
    <property name="commerceBeanFactory" ref="commerceBeanFactory"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="commerceUserSessionService" class="com.coremedia.livecontext.ecommerce.ibm.user.UserSessionServiceImpl"
        parent="storeFrontService">
    <property name="commerceCache" ref="commerceCache"/>
    <property name="urlProvider" ref="pageHandlerUrlProvider"/>
    <property name="wcsStorefrontUrl" value="${livecontext.ibm.wcs.default.url}"/>
    <property name="loginWrapperService" ref="loginWrapperService"/>
    <property name="userService" ref="commerceUserService"/>
  </bean>

  <bean id="storeContextProvider" class="com.coremedia.livecontext.ecommerce.ibm.common.StoreContextProviderImpl">
    <property name="sitesService" ref="sitesService"/>
    <property name="settingsService" ref="settingsService"/>
    <property name="wcsVersion" value="${livecontext.ibm.wcs.version}"/>
    <property name="storeConfigurations" ref="storeConfigurations"/>
    <property name="cache" ref="cache"/>
  </bean>

  <util:map id="anAlternativeStoreConfig">
    <entry key="store.id" value="12345"/>
    <entry key="store.name" value="springsite"/>
    <entry key="catalog.id" value="67890"/>
    <entry key="currency" value="EUR"/>
    <entry key="workspace.id" value="0815"/>
    <entry key="livecontext.ibm.wcs.host" value="host-from-spring"/>
    <entry key="spring.only.setting" value="spring.only.setting"/>
    <entry key="connection.id" value="wcs1"/>
  </util:map>

  <util:map id="storeConfigurations">
    <description>
      List of store configurations. Add your own configs via customizers.
    </description>
    <!--empty by default-->
    <entry key="anAlternativeStoreConfig" value-ref="anAlternativeStoreConfig"/>
  </util:map>

  <bean id="assetUrlProvider" class="com.coremedia.livecontext.ecommerce.ibm.asset.AssetUrlProviderImpl">
    <property name="commercePreviewUrl" value="${livecontext.apache.preview.wcs.url}"/>
    <property name="commerceProductionUrl" value="${livecontext.apache.wcs.url}"/>
    <property name="cmsHost" value="localhost"/>
    <property name="catalogPathPrefix" value="${livecontext.ibm.wcs.store.catalog.asset.path}"/>
  </bean>

  <bean id="commerceIdProvider" class="com.coremedia.livecontext.ecommerce.ibm.common.CommerceIdProviderImpl"/>

  <bean id="storeInfoService" class="com.coremedia.livecontext.ecommerce.ibm.storeinfo.StoreInfoServiceImpl">
    <property name="wrapperService" ref="storeInfoWrapperService"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="storeInfoWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.storeinfo.WcStoreInfoWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="restConnector" class="com.coremedia.livecontext.ecommerce.ibm.common.WcRestConnector">
    <property name="serviceEndpoint" value="${livecontext.ibm.wcs.rest.url}"/>
    <property name="searchServiceEndpoint" value="${livecontext.ibm.wcs.rest.search.url}"/>
    <property name="serviceSslEndpoint" value="${livecontext.ibm.wcs.rest.secureUrl}"/>
    <property name="searchServiceSslEndpoint" value="${livecontext.ibm.wcs.rest.search.secureUrl}"/>
    <property name="trustAllSslCertificates" value="true"/>
    <property name="loginService" ref="userLoginService"/>
  </bean>

  <bean id="userLoginService" class="com.coremedia.livecontext.ecommerce.ibm.login.LoginServiceImpl">
    <property name="servicePassword" value="${service.credentials.password}"/>
    <property name="serviceUser" value="${service.credentials.username}"/>
    <property name="loginWrapperService" ref="loginWrapperService"/>
    <property name="commerceCache" ref="commerceCache"/>
  </bean>

  <bean id="loginWrapperService" class="com.coremedia.livecontext.ecommerce.ibm.login.WcLoginWrapperService">
    <property name="restConnector" ref="restConnector"/>
  </bean>

  <bean id="commerceCache" class="com.coremedia.blueprint.base.livecontext.ecommerce.common.CommerceCache">
    <property name="cache" ref="cache"/>
    <property name="enabled" value="false"/>
    <property name="cacheTimesInSeconds">
      <map>
        <entry key="Product" value="30"/>
        <entry key="Category" value="30"/>
        <entry key="MarketingSpots" value="30"/>
        <entry key="MarketingSpot" value="30"/>
        <entry key="ProductsByCategory" value="30"/>
        <entry key="TopCategories" value="30"/>
        <entry key="SubCategories" value="30"/>
        <entry key="DynamicPrice" value="30"/>
        <entry key="StaticPrice" value="30"/>
        <entry key="Availability" value="30"/>
        <entry key="PreviewToken" value="120"/>
        <entry key="SegmentsByUser" value="30"/>
      </map>
    </property>
    <property name="capacities">
      <map>
        <entry key="Product" value="10"/>
        <entry key="Category" value="10"/>
        <entry key="MarketingSpots" value="10"/>
        <entry key="MarketingSpot" value="10"/>
        <entry key="ProductsByCategory" value="10"/>
        <entry key="TopCategories" value="10"/>
        <entry key="SubCategories" value="10"/>
        <entry key="DynamicPrice" value="10"/>
        <entry key="StaticPrice" value="10"/>
        <entry key="Availability" value="10"/>
        <entry key="PreviewToken" value="10"/>
        <entry key="SegmentsByUser" value="10"/>
      </map>
    </property>
  </bean>


</beans>
